#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <string.h>

#include "wasm_export.h"
#include "blob/hello.wasm.h"
#include "wasm_libs.h"

bool iwasm_runtime_init(void);
void iwasm_runtime_destroy(void);
int iwasm_instance_exec_main(wasm_module_inst_t, int, char**);

void printd(double d) {
    printf("%f", d);
}

int main(void)
{
    uint8_t* bytecode = malloc(hello_wasm_len);
    size_t bytecode_len = hello_wasm_len;
    memcpy(bytecode, hello_wasm, bytecode_len);

    if (!iwasm_runtime_init()) {
        printf("Could not initialize WASM runtime!\n");
        return 1;
    }

    // register natives grouped by libraries generated by RIOT LibGen
    if (!wasm_libs_register_io_natives("env")) {
        printf("Could not register natives!\n");
        iwasm_runtime_destroy();
        return 1;
    }
    if (!wasm_libs_register_math_natives("env")) {
        printf("Could not register natives!\n");
        iwasm_runtime_destroy();
        return 1;
    }
    if (!wasm_libs_register_easysaul_natives("env")) {
        printf("Could not register natives!\n");
        iwasm_runtime_destroy();
        return 1;
    }

    // load WASM module (the compiled WASM binary)
    wasm_module_t wasm_module = NULL;
    {
        char error_buf[128];
        if (!(wasm_module = wasm_runtime_load(bytecode, bytecode_len,
                                              error_buf, sizeof(error_buf)))) {
            puts(error_buf);
            return 1;
        }
    }

    // instantiate WASM module
    wasm_module_inst_t wasm_module_inst = NULL;
    {
        char error_buf[128];
        if (!(wasm_module_inst = wasm_runtime_instantiate(wasm_module, 8 * 1024,
            8 * 1024, error_buf, sizeof(error_buf)))) {
            puts(error_buf);
            return 1;
        }
    }

    // the WASM libraries generated by RIOT LibGen need a reference to the WASM module instance in order to access the WASM context
    wasm_libs_set_wasm_module_inst(wasm_module_inst);

    // execute main function of the loaded WASM module
    const char *exception = 0;
    //int ret = 0;
    int argc = 0;
    char** argv = NULL;
    wasm_application_execute_main(wasm_module_inst, argc, argv);
    if ((exception = wasm_runtime_get_exception(wasm_module_inst))) {
        puts(exception);
        return 1;
    }
    /*if (argc > 0) {
        ret = *((int*)argv);
    }
    printf("ret = %d\n", ret);*/

    // destroy the WASM module instance
    wasm_runtime_deinstantiate(wasm_module_inst);

    // unload WASM module
    wasm_runtime_unload(wasm_module);

    // destroy WASM runtime
    iwasm_runtime_destroy();

    return 0;
}